{#发表页#}
{% extends 'base/frame.html' %}
{% load static %}
{% block CustomCss %}
    <link rel="stylesheet" href="{% static "css/markdown/editormd.css" %}" />
{#    <link rel="stylesheet" href="{% static "css/style.css" %}">#}
    <style>
        ul[data-id='sort-name'],
        ul[data-id='label-name']{
            z-index: 2003;
        }
    </style>
{% endblock %}

{% block content %}

    <div class="row">
      <div class="col-lg-12">
        <div class="input-group">
          <div class="input-group-btn">
            <button type="button" class="btn btn-default " aria-haspopup="true" aria-expanded="false">标题</button>
          </div>
          <input type="text" class="form-control" data-id="titleName" aria-label="..." placeholder="在此输入标题">
          <div class="input-group-btn">
            <button type="button" class="btn btn-default dropdown-toggle" data-id="sort-name" data-value="-1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">分类<span class="caret"></span></button>
            <ul class="dropdown-menu dropdown-menu-right" data-id = "sort-name">
              {% for foo in sort %}
                <li><a href="#">{{ foo }}</a></li>
              {% endfor %}

{#              <li><a href="#">Action</a></li>#}
{#              <li><a href="#">Another action</a></li>#}
{#              <li><a href="#">Something else here</a></li>#}
{#              <li role="separator" class="divider"></li>#}
{#              <li><a href="#">Separated link</a></li>#}
            </ul>
          </div>
          <div class="input-group-btn">
            <button type="button" class="btn btn-default dropdown-toggle" data-id = "label-name" data-value="-1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">标签<span class="caret"></span></button>
            <ul class="dropdown-menu dropdown-menu-right" data-id = "label-name">
{#                <li><a href="#">Actions</a></li>#}
{#                <li><a href="#">Another actions</a></li>#}
{#                <li><a href="#">Something else heres</a></li>#}
{#                <li role="separator" class="divider"></li>#}
{#                <li><a href="#">Separated links</a></li>#}
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div style="z-index: 2002">
        <div id="editormd">
            <textarea style="display:none;"></textarea>
        </div>
    </div>
{#    <div class="ibox-content" style="z-index: 99999">#}
{#        <div class="spiner-example">#}
            <div class="sk-spinner sk-spinner-cube-grid">
                <div class="sk-cube"></div>
                <div class="sk-cube"></div>
                <div class="sk-cube"></div>
                <div class="sk-cube"></div>
                <div class="sk-cube"></div>
                <div class="sk-cube"></div>
                <div class="sk-cube"></div>
                <div class="sk-cube"></div>
                <div class="sk-cube"></div>
            </div>
{#        </div>#}
{#    </div>#}
{% endblock %}

{% block CustomJs %}
    <script src="{% static "js/markdown/editormd.js" %}"></script>
    <script>
        let left_nav_width = $("div.left-nav").outerWidth(),
            window_height = $(window).height(),
            document_width = $(document).width();
        let left_nav_width_temp = left_nav_width;
        let timer;
        function give_height() {
            if(timer){
                clearTimeout(timer);
            }
            timer = setTimeout(function () {
                window_height = $(window).height();
                document_width = $(document).width();
                {#alert($(window).height()+","+$(document).height())#}
                if (document_width <= 1024){
                    left_nav_width_temp = 0;
                }else{
                    left_nav_width_temp = left_nav_width;
                }
                {#$("div.content").css("height", document_height-101+"px");#}
                $("#editormd, div.CodeMirror, div.editormd-preview").css("height", window_height - 136 + "px");
                timer = null;
                {#console.log($(".editormd-preview").html());#}
            },0)
        }
        (function () {
            {#give_height();#}
        })();

        $(function() {
            $(window).resize(function () {
                give_height();
            });
            let testEditor = editormd("editormd", {
                z_index: 2002,
                width: "inherit",
                height: ($(document).height()-136) + 'px', //减去上面bar的高度，输入框组，footer的高度
                margin: "0",
                flowChart: true,
                tex: true,
                theme: (localStorage.theme) ? localStorage.theme : "dark",
                previewTheme: (localStorage.previewTheme) ? localStorage.previewTheme : "dark",
                editorTheme: (localStorage.editorTheme) ? localStorage.editorTheme : "pastel-on-dark",
                path: '/static/lib/',
                imageUpload: true,
                toolbarIcons : function() {
                    let i = editormd.toolbarModes.full;
                    i.push("upload");
                    return i;
                },
                toolbarIconsClass : {
                    upload : "fa-cloud-upload"  // 指定一个FontAawsome的图标类
                },
                toolbarIconTexts : {
                    upload : ""  // 如果没有图标，则可以这样直接插入内容，可以是字符串或HTML标签
                },
                lang : {
                    toolbar : {
                        upload : "发布文章",
                    }
                },
                toolbarHandlers : {
                    upload : function () {
                        console.log("123")
                        let article = this.getPreviewedHTML(),
                            markdown = this.getMarkdown(),
                            sort_name = $("button[data-id='sort-name']").attr('data-value'),
                            label_name = $("button[data-id='label-name']").attr('data-value'),
                            title_name = $("input[data-id='titleName']").val();

                        swal({
                            title: "确认?",
                            text: "发表当前的文章吗",
                            type: "warning",
                            showCancelButton: true,
                            confirmButtonColor: "#DD6B55",
                            confirmButtonText: "确认",
                            cancelButtonText: "取消",
                            closeOnConfirm: false
                        }, function () {
                            $.ajax({
                                url:'article/save',
                                type: 'POST',
                                data: {
                                    article: article,
                                    markdown: markdown,
                                    sort_name: sort_name,
                                    label_name: label_name,
                                    title_name: title_name
                                },
                                headers:{"X-CSRFToken":$.cookie('csrftoken')},
                                success: function (res) {
                                    console.log(res);
                                    res = JSON.parse(res);
                                    console.log(res.code);
                                    if(res.code === 200){
                                        swal("成功!", "已发表", "success");
                                    }else{
                                        swal("失败!", "未发表", "error");
                                    }
                                }
                            })
                        });

                    }
                },

            });

            setTimeout(function () {
                console.log(testEditor.getMarkdown())
            },8000);

            {#左上角按钮重新调正编辑器大小#}
            $('a.navbar-minimalize').click(function () {
                var i = 0;
                var ti = setInterval(function () {
                    i++;
                    if(i >= 72){
                        clearInterval(ti);
                    }
                    testEditor.resize();
                },5)
            });

        });
        $("ul[data-id='sort-name'] li a").click(function () {
            let s = $("button[data-id='sort-name']");
            s.attr('data-value', $(this).html());
            s.html($(this).html())
        });
        $("ul[data-id='label-name'] li a").click(function () {
            let s = $("button[data-id='label-name']");
            s.attr('data-value', $(this).html());
            s.html($(this).html())
        });
        document.addEventListener('visibilitychange', function () {
            let isHidden = document.hidden;
            if (isHidden) {
                document.title = 'O_O';
            } else {
                document.title = '·_·';
            }
        });
        window.onbeforeunload = function (event) {
            return "提示：您尚有未保存的内容，离开本页将丢失编辑内容！:)";
        };

    </script>
{% endblock %}